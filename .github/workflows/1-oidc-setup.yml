# ==============================================================================
# 1ï¸âƒ£ OIDC CONNECTION SETUP
# Purpose: Verify and establish Azure OIDC connection
# Trigger: Manual - Run this FIRST before any other workflow
# Flow: OIDC âœ“ â†’ [Manual] CI â†’ [Manual] Infrastructure â†’ [Manual] CD
# ==============================================================================

name: 1ï¸âƒ£ OIDC Connection Setup

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  # ============================================================================
  # Step 1: Verify Azure OIDC Connection
  # ============================================================================
  verify-connection:
    name: ðŸ” Verify Azure OIDC Connection
    runs-on: ubuntu-latest
    outputs:
      connection-status: ${{ steps.verify.outputs.status }}
      subscription-name: ${{ steps.verify.outputs.subscription_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        id: login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Connection
        id: verify
        run: |
          echo "### ðŸ” Azure OIDC Connection Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get account info
          ACCOUNT_INFO=$(az account show --query "{Name:name, Id:id, TenantId:tenantId, State:state}" -o json)
          SUBSCRIPTION_NAME=$(echo $ACCOUNT_INFO | jq -r '.Name')
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "subscription_name=$SUBSCRIPTION_NAME" >> $GITHUB_OUTPUT
          
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Subscription | \`$SUBSCRIPTION_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tenant ID | \`$(echo $ACCOUNT_INFO | jq -r '.TenantId')\` |" >> $GITHUB_STEP_SUMMARY
          echo "| State | \`$(echo $ACCOUNT_INFO | jq -r '.State')\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **OIDC Connection Verified Successfully!**" >> $GITHUB_STEP_SUMMARY

      - name: List Available Resources
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Available Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### Resource Groups" >> $GITHUB_STEP_SUMMARY
          az group list --query "[].{Name:name, Location:location}" -o table >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No resource groups found" >> $GITHUB_STEP_SUMMARY

      - name: Next Steps
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âž¡ï¸ Next Steps (Manual)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Workflow | Action |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | âœ… **1ï¸âƒ£ OIDC Setup** | Complete |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | **2ï¸âƒ£ CI - Build & Test** | Run manually to test code |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | **3ï¸âƒ£ Infrastructure Setup** | Run to create Azure resources |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | **4ï¸âƒ£ CD - Deploy** | Run to deploy application |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Go to **Actions** tab and run the next workflow when ready." >> $GITHUB_STEP_SUMMARY

      - name: Azure Logout
        if: always()
        run: az logout
