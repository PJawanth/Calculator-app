# ==============================================================================
# 1ï¸âƒ£ OIDC CONNECTION SETUP
# Purpose: Verify and establish Azure OIDC connection
# Trigger: Manual - Run this FIRST before any other workflow
# Next: Triggers CI workflow on success
# ==============================================================================

name: 1ï¸âƒ£ OIDC Connection Setup

on:
  workflow_dispatch:
    inputs:
      verify_only:
        description: 'Only verify connection (no trigger next workflow)'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read
  actions: write

jobs:
  # ============================================================================
  # Step 1: Verify Azure OIDC Connection
  # ============================================================================
  verify-connection:
    name: ðŸ” Verify Azure OIDC Connection
    runs-on: ubuntu-latest
    outputs:
      connection-status: ${{ steps.verify.outputs.status }}
      subscription-name: ${{ steps.verify.outputs.subscription_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        id: login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Connection
        id: verify
        run: |
          echo "### ðŸ” Azure OIDC Connection Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get account info
          ACCOUNT_INFO=$(az account show --query "{Name:name, Id:id, TenantId:tenantId, State:state}" -o json)
          SUBSCRIPTION_NAME=$(echo $ACCOUNT_INFO | jq -r '.Name')
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "subscription_name=$SUBSCRIPTION_NAME" >> $GITHUB_OUTPUT
          
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Subscription | \`$SUBSCRIPTION_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tenant ID | \`$(echo $ACCOUNT_INFO | jq -r '.TenantId')\` |" >> $GITHUB_STEP_SUMMARY
          echo "| State | \`$(echo $ACCOUNT_INFO | jq -r '.State')\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **OIDC Connection Verified Successfully!**" >> $GITHUB_STEP_SUMMARY

      - name: List Available Resources
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Available Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### Resource Groups" >> $GITHUB_STEP_SUMMARY
          az group list --query "[].{Name:name, Location:location}" -o table >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No resource groups found" >> $GITHUB_STEP_SUMMARY

      - name: Azure Logout
        if: always()
        run: az logout

  # ============================================================================
  # Step 2: Trigger CI Workflow (if not verify_only)
  # ============================================================================
  trigger-ci:
    name: ðŸš€ Trigger CI Workflow
    runs-on: ubuntu-latest
    needs: verify-connection
    if: ${{ needs.verify-connection.outputs.connection-status == 'success' && inputs.verify_only != true }}

    steps:
      - name: Trigger CI workflow
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '2-ci.yml',
              ref: context.ref
            });
            
            core.summary.addRaw('### ðŸš€ CI Workflow Triggered!\n\n');
            core.summary.addRaw('The CI workflow has been started. Check the Actions tab for progress.\n');
            await core.summary.write();

      - name: Next Steps
        run: |
          echo "### âž¡ï¸ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… OIDC Connection verified" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ”„ CI Workflow triggered" >> $GITHUB_STEP_SUMMARY
          echo "3. â³ Wait for CI to complete" >> $GITHUB_STEP_SUMMARY
          echo "4. âž¡ï¸ After CI passes, proceed to Infrastructure setup" >> $GITHUB_STEP_SUMMARY
